# Правила игры — PaperFX (MVP)

Эта версия правил соответствует **текущей реализации в MVP** (сервер: `server/Room.java`).

---

## 1) Суть
Игроки движутся по прямоугольному клеточному полю. Каждая клетка может принадлежать одному игроку (территория) или быть ничьей.

Игрок, выходя за пределы своей территории, оставляет **след** (trail). Когда след **замыкается** (возврат на свою территорию или самопересечение следа), вся область, “отрезанная” следом, становится территорией игрока. Захват **перезаписывает** владельцев клеток (можно отжимать территорию у других).

---

## 2) Поле и координаты

- Размер сетки: `gridW×gridH = 80×60`
- Размер клетки: `cellSize = 10` (пикселей)
- Карта владельцев: массив `owners[gridW*gridH]`, где
  - `0` — ничья
  - `1..4` — индекс игрока (`idx`)

> Игроки перемещаются **плавно в пикселях**, но захваты/след считаются по клеткам, в которые попадает центр игрока.

---

## 3) Игрок

У игрока есть:
- `playerId` (UUID строкой)
- `idx` (1..4) — номер владельца клеток
- позиция `x/y` в пикселях
- текущий ввод `dx/dy` ∈ `{-1,0,1}` (без диагонали)
- `trail` — список уникальных клеток следа

### Спавн
При входе игрока в комнату:
- выбирается случайная клетка `(sx, sy)`
- игрок получает стартовую территорию квадратом радиуса `SPAWN_R = 3` (то есть `7×7` клеток вокруг спавна)

---

## 4) Движение

- Ввод задаёт скорость по осям.
- Диагональ запрещена: если `dx != 0` и `dy != 0`, считается только `dx`.
- Игровой цикл сервера выполняется примерно раз в **50 мс** (≈20Hz).
- Скорость игрока: `PLAYER_SPEED = 240` пикс/сек.

Чтобы не “перепрыгивать” клетки при большой скорости, сервер обрабатывает переход по клеткам через линию Брезенхэма между прошлой и новой клеткой.

---

## 5) След (trail)

При входе в клетку `(x,y)` сервер проверяет:

1) **Убийство по пересечению следа**  
Если *другой* игрок имеет клетку `(x,y)` в своём `trail`, то **умирает этот другой игрок**.  
Важно: умирает **владелец пересечённого следа**, а не тот, кто пересёк.

2) **Добавление следа**  
Если клетка не принадлежит территории игрока (`owners[x,y] != idx`), она добавляется в `trail` (уникально).

---

## 6) Замыкание и захват территории

Замыкание происходит в двух случаях:

- Игрок **вернулся на свою территорию** (`owners[x,y] == idx`) и при этом `trail` не пуст.
- Игрок **сам пересёк свой след** (зашёл в клетку, которая уже есть в `trail`) и длина `trail >= 2`.

### Как считается захват (алгоритм)
Сервер выполняет flood‑fill “снаружи”:

- Стены (`blocked`) = текущая территория игрока + клетки его следа.
- Из границ поля запускается поиск по клеткам, которые **не** являются стенами → помечается “снаружи”.
- Все клетки, которые **не** являются стенами и **не достижимы снаружи**, считаются “внутри” и становятся территорией игрока (owner = `idx`).
- Затем **весь след** тоже превращается в территорию.
- `trail` очищается.

> Захват **перезаписывает** владельцев — так реализовано “воровство” территории.

---

## 7) Очки

`score` игрока = количество клеток на поле, где `owner == idx` (размер текущей территории).

---

## 8) Смерть и респавн

Игрок умирает, если **кто-то пересёк его след** (см. п. 5.1). При смерти:
- текущий результат (`score`) записывается в БД
- территория игрока сбрасывается (его клетки становятся `0`)
- след очищается
- игрок респавнится в случайной клетке и получает стартовую территорию `7×7`
- игрок на короткое время “заморожен” (кулдаун 10 тиков)

---

## 9) Матч и окончание игры

В текущем MVP:
- нет таймера матча и явного “конца” — игра в комнате идёт постоянно
- игроки могут присоединяться к комнате в процессе
- лидерборд в `state` показывает текущие территории игроков в комнате
