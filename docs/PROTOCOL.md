# PROTOCOL — PaperFX (TCP, JSON Lines)

Формат обмена: **каждое сообщение — одна строка JSON** (JSONL) поверх **TCP**.

- Транспорт: Java `Socket` / `ServerSocket` (**единственный допустимый транспорт для TCP**)  
- Сериализация: Jackson (`common/Net.java`)
- Кодировка: UTF‑8
- Разделитель сообщений: `\n` (строка)

> Сервер является **авторитетным**: клиент отправляет только ввод, а состояние игры вычисляет и рассылает сервер.

---

## 1) Подключение

- По умолчанию: `127.0.0.1:7777`
- Клиент устанавливает TCP-соединение и далее обменивается JSONL.

---

## 2) Общие правила протокола

1. В каждом сообщении есть поле `type`.
2. Неизвестные поля игнорируются сервером (Jackson настроен с `FAIL_ON_UNKNOWN_PROPERTIES = false`).
3. Сервер может отправлять:
   - `error` как ответ на некорректное действие,
   - `state` периодически (снапшот состояния комнаты),
   - `chat_msg` при сообщениях чата.
4. После успешного `login` сервер **автоматически** подключает игрока в комнату `MAIN` как обычного игрока.

---

## 3) Сообщения клиент → сервер

### 3.1 register
Регистрация пользователя. После успешной регистрации сервер делает авто‑логин.

```json
{"type":"register","username":"user1","password":"pass1234"}
```

Ответы:
- `auth_ok` (после авто-логина)
- `error`

Валидация на сервере:
- `username` длина 3..24
- допустимые символы `a-zA-Z0-9_-`
- `password` длина >= 6

---

### 3.2 login
Логин пользователя.

```json
{"type":"login","username":"user1","password":"pass1234"}
```

Особенность: **1 активная сессия на username**. Новый логин кикает старое подключение (старому соединению приходит `error` с `reason="kicked_duplicate_login"`).

Ответы:
- `auth_ok`
- `error`

---

### 3.3 input
Игровой ввод: направление движения по осям.

```json
{"type":"input","dx":1,"dy":0}
```

- `dx`, `dy` ∈ `{-1,0,1}`
- Диагональ запрещена: если `dx != 0` и `dy != 0`, сервер принудительно обнуляет `dy`.

> Примечание: текущее MVP отправляет `input` примерно ~30 раз/сек (клиентская частота), а сервер использует **последнее** полученное значение в своём игровом цикле.

---

### 3.4 create_room
Создать/получить комнату и присоединиться к ней игроком.

```json
{"type":"create_room","roomId":"ROOM123"}
```

- `roomId` опционален. Если пустой/отсутствует — сервер генерирует id вида `R<hex>`.
- Комната создаётся лениво: если такой комнаты не было, сервер создаст её.

Ответы:
- `room_joined`
- `error`

---

### 3.5 join_room
Присоединиться к комнате.

```json
{"type":"join_room","roomId":"MAIN","spectator":false}
```

Поля:
- `roomId` — идентификатор комнаты (по умолчанию `MAIN`)
- `spectator` — режим наблюдателя:
  - `false` → создаётся игровой игрок
  - `true` → игрок **не создаётся**, управление недоступно, но состояние (`state`) приходит

Ответы:
- `room_joined`
- `error`

---

### 3.6 chat_send
Отправить сообщение в чат комнаты.

```json
{"type":"chat_send","text":"Привет!"}
```

Ограничения:
- длина ≤ 300 символов
- rate‑limit: 1 сообщение / 5 секунд (на соединение)

Ответы:
- сообщение рассылается всем в комнате через `chat_msg`
- при нарушении ограничений — `error`

---

### 3.7 ping
Keepalive (опционально).

```json
{"type":"ping"}
```

---

## 4) Сообщения сервер → клиент

### 4.1 auth_ok
Успешная авторизация.

```json
{
  "type":"auth_ok",
  "userId":"uuid",
  "username":"user1",
  "playerId":"",
  "idx":0,
  "color":"#4CC9F0",
  "bestScore":123
}
```

Поля:
- `userId` — UUID пользователя (строка)
- `username` — логин
- `bestScore` — лучший результат пользователя в БД (best_score)
- `playerId`, `idx`, `color` — в текущем MVP **в `auth_ok` заполняются как “лобби‑значения”** (реальные `playerId/idx/color` приходят после `room_joined`/в `state`)

---

### 4.2 room_joined
Подтверждение входа в комнату.

```json
{
  "type":"room_joined",
  "roomId":"MAIN",
  "capacity":4,
  "spectator":false,
  "playerId":"uuid",
  "players":2
}
```

- `playerId` присутствует только если `spectator=false`
- `players` — текущее число игроков (без наблюдателей)

---

### 4.3 state
Снапшот состояния комнаты (приходит периодически, сейчас — каждый тик игрового цикла).

```json
{
  "type":"state",
  "tick":42,
  "roomId":"MAIN",
  "cellSize":10,
  "gridW":80,
  "gridH":60,
  "owners":[0,0,1,...],
  "players":[
    {
      "playerId":"uuid",
      "idx":1,
      "username":"user1",
      "x":120.5,
      "y":88.0,
      "score":95,
      "color":"#4CC9F0",
      "trail":[{"x":10,"y":10},{"x":11,"y":10}]
    }
  ],
  "leaderboard":[{"username":"user1","bestScore":95}]
}
```

Поля:
- `owners` — массив длиной `gridW*gridH`, владелец клетки:
  - `0` = ничья
  - `1..4` = индекс игрока (`idx`)
- `players[].x/y` — координаты в **пикселях** (верхний левый угол спрайта), а не в клетках
- `players[].trail` — список клеток следа (может быть `null`)
- `leaderboard` — **внутрикомнатный** лидерборд; `bestScore` здесь означает текущий score (размер территории)

---

### 4.4 chat_msg
Сообщение чата.

```json
{
  "type":"chat_msg",
  "roomId":"MAIN",
  "from":"user1",
  "text":"Привет!",
  "ts":1730000000000
}
```

---

### 4.5 error
Ошибка.

```json
{"type":"error","reason":"room_full"}
```

Типовые `reason` в текущем MVP:
- `not_authenticated`
- `already_authenticated`
- `unknown_message`
- `server_error`
- `kicked_duplicate_login`
- `invalid username/password`
- `username already exists`
- `username must be 3..24 chars`
- `username allowed: [a-zA-Z0-9_-]`
- `password must be >= 6 chars`
- `room_full`
- `chat_rate_limit`
- `chat_too_long`

---

## 5) Замечания для кастомного клиента

- После `login` сервер сам присоединит вас в `MAIN`, но вы можете затем отправить `create_room` / `join_room`.
- Наблюдатель (`spectator=true`) не получает `playerId`; `input` для него игнорируется.
- Протокол намеренно “плоский” (без ack-ответов) — всё важное отражается в `state` и событиях (`chat_msg`/`error`).
