# PROTOCOL — PaperFX (UDP, JSON)

Формат обмена: **1 UDP-датаграмма = 1 JSON-сообщение** (UTF‑8).

- Транспорт: Java `DatagramSocket` (**единственный допустимый транспорт для UDP**)  
- Сериализация: Jackson (`common/Net.java`)
- Размер сообщения: должно умещаться в одну датаграмму (в проекте используется буфер 64KB на приёме)
- Граница сообщения: граница UDP-датаграммы (символ `\n` в конце **не обязателен**, но клиент/сервер могут добавлять его «для удобства»)

> Сервер является **авторитетным**: клиент отправляет только запросы/ввод, а состояние игры вычисляет и рассылает сервер.

---

## 1) Подключение и идентификация сессии

- По умолчанию: `127.0.0.1:7777`
- «Сессия» клиента в UDP-режиме определяется по адресу **(IP:порт)**, с которого приходят датаграммы.
- Сервер хранит состояние сессии (авторизация, комната, playerId и т.д.) у себя.
- Если клиент перестаёт отправлять датаграммы, сервер удаляет сессию по таймауту бездействия (**~90 секунд**).

Рекомендация: периодически отправляйте `ping`, если у клиента нет другой сетевой активности.

---

## 2) Общие правила протокола

1. В каждом сообщении есть поле `type`.
2. Неизвестные поля игнорируются сервером (Jackson настроен с `FAIL_ON_UNKNOWN_PROPERTIES = false`).
3. Большинство ошибок возвращаются как `error` (см. ниже).
4. Сервер периодически рассылает `state` всем подключённым в комнате (игрокам и наблюдателям).
5. После успешного `login` сервер **автоматически** присоединяет пользователя к комнате:
   - `MAIN`, если в ней есть место;
   - иначе — к любой другой неполной комнате;
   - иначе — создаёт комнату `AUTO<N>` и присоединяет туда.

---

## 3) Сообщения клиент → сервер

### 3.1 register
Регистрация пользователя. После успешной регистрации сервер делает авто‑логин.

```json
{"type":"register","username":"user1","password":"pass1234"}
```

Ответы:
- `auth_ok` (после авто-логина)
- `error`

Валидация:
- `username` длина 3..24
- допустимые символы `a-zA-Z0-9_-`
- `password` длина >= 6

---

### 3.2 login
Логин пользователя.

```json
{"type":"login","username":"user1","password":"pass1234"}
```

Особенность: **1 активная сессия на username**. Новый логин «кикает» старое подключение — старой сессии отправляется `error` с `reason="kicked_duplicate_login"`.

Ответы:
- `auth_ok`
- `error`

---

### 3.3 input
Игровой ввод: направление движения по осям.

```json
{"type":"input","dx":1,"dy":0}
```

- `dx`, `dy` ∈ `{-1,0,1}`
- Диагональ запрещена: если `dx != 0` и `dy != 0`, сервер принудительно обнуляет `dy`.
- Ввод для наблюдателя (`spectator=true`) игнорируется.

---

### 3.4 create_room
Создать (при необходимости) комнату и присоединиться к ней игроком.

```json
{"type":"create_room","roomId":"ROOM123"}
```

- `roomId` опционален. Если пустой/отсутствует — сервер генерирует id вида `R<hex>`.
- Комната создаётся лениво: если такой комнаты не было, сервер создаст её.

Ответы:
- `room_joined`
- `error`

---

### 3.5 join_room
Присоединиться к комнате (как игрок или наблюдатель).

```json
{"type":"join_room","roomId":"MAIN","spectator":false}
```

Поля:
- `roomId` — идентификатор комнаты (по умолчанию `MAIN`)
- `spectator`:
  - `false` → создаётся игровой игрок (если есть место)
  - `true` → игрок **не создаётся**, управление недоступно, но `state` приходит

Ответы:
- `room_joined`
- `error`

---

### 3.6 chat_send
Отправить сообщение в чат комнаты.

```json
{"type":"chat_send","text":"Привет!"}
```

Ограничения:
- длина ≤ 300 символов
- rate‑limit: 1 сообщение / 5 секунд (на сессию)

Ответы:
- сообщение рассылается всем в комнате через `chat_msg`
- при нарушении ограничений — `error`

---

### 3.7 profile_get
Получить профиль/статистику/достижения текущего пользователя.

```json
{"type":"profile_get"}
```

Ответы:
- `profile`
- `error`

---

### 3.8 ping
Keepalive (опционально).

```json
{"type":"ping"}
```

---

## 4) Сообщения сервер → клиент

### 4.1 auth_ok
Успешная авторизация.

```json
{
  "type":"auth_ok",
  "userId":"uuid",
  "username":"user1",
  "playerId":"",
  "idx":0,
  "color":"#4CC9F0",
  "bestScore":123
}
```

Поля:
- `userId` — UUID пользователя (строка)
- `username` — логин
- `bestScore` — лучший результат пользователя в БД
- `playerId`, `idx`, `color` — «служебные» значения; реальные `playerId/idx/color` приходят после `room_joined` и/или видны в `state`.

---

### 4.2 room_joined
Подтверждение входа в комнату.

```json
{
  "type":"room_joined",
  "roomId":"MAIN",
  "capacity":4,
  "spectator":false,
  "playerId":"uuid",
  "players":2
}
```

- `playerId` присутствует только если `spectator=false`
- `players` — число игроков (без наблюдателей)

---

### 4.3 state
Снапшот состояния комнаты (приходит периодически, сейчас — каждый тик игрового цикла).

```json
{
  "type":"state",
  "tick":42,
  "roomId":"MAIN",
  "cellSize":10,
  "gridW":80,
  "gridH":60,
  "owners":[0,0,1],
  "players":[
    {
      "playerId":"uuid",
      "idx":1,
      "username":"user1",
      "x":120.5,
      "y":88.0,
      "score":95,
      "color":"#4CC9F0",
      "trail":[{"x":10,"y":10},{"x":11,"y":10}]
    }
  ],
  "leaderboard":[{"username":"user1","bestScore":95}]
}
```

Замечания:
- `owners` — массив длиной `gridW*gridH`, владелец клетки:
  - `0` = ничья
  - `1..4` = индекс игрока (`idx`)
- `players[].x/y` — координаты в **пикселях**
- `players[].trail` — список клеток следа (может быть `null`)
- `leaderboard` — лидерборд по текущей территории в комнате (поле `bestScore` здесь — текущий score)

---

### 4.4 chat_msg
Сообщение чата (обычное или системное).

```json
{
  "type":"chat_msg",
  "roomId":"MAIN",
  "from":"user1",
  "text":"Привет!",
  "ts":1730000000000
}
```

---

### 4.5 profile
Профиль/статистика пользователя.

```json
{
  "type":"profile",
  "username":"user1",
  "killsTotal":10,
  "areaTotal":2500,
  "bestScore":500,
  "bestKillsInGame":3,
  "bestKillStreak":2,
  "achievements":["KILLS_1","AREA_100"]
}
```

---

### 4.6 error
Ошибка.

```json
{"type":"error","reason":"room_full"}
```

Типовые `reason` (актуально для текущей реализации):
- `not_authenticated`
- `already_authenticated`
- `unknown_message`
- `bad_message`
- `server_error`
- `profile_error`
- `kicked_duplicate_login`
- `invalid username/password`
- `username already exists`
- `username must be 3..24 chars`
- `username allowed: [a-zA-Z0-9_-]`
- `password must be >= 6 chars`
- `room_full`
- `chat_rate_limit`
- `chat_too_long`

---

## 5) Замечания для кастомного клиента

- UDP не гарантирует доставку/порядок. В протоколе это компенсируется тем, что сервер регулярно шлёт полный `state`.
- `input` можно отправлять часто (клиент отправляет «последнее желание» направления); сервер использует последнее полученное значение.
- Для долгих пауз/свёрнутого окна стоит посылать `ping`, иначе сервер удалит сессию по таймауту.
