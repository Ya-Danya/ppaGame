# Техническое задание — PaperFX (актуально для версии UDP из архива)

Документ описывает **текущее состояние проекта** и фиксирует, что уже реализовано.

---

## 1. Цель проекта
Создать сетевую многопользовательскую игру, похожую на paper.io: **PaperFX** (клиент–сервер),
где сервер авторитетно ведёт состояние игры в комнатах, а клиент визуализирует поле и отправляет ввод.

---

## 2. Ограничения и ключевые требования
- Язык: **Java 17**
- Сеть (строго):
  - UDP: `java.net.DatagramSocket`
- Формат сообщений: **UDP + JSON** (см. `PROTOCOL.md`)
- Сервер — источник истины (anti‑cheat базово обеспечивается авторитетностью сервера)

---

## 3. Стек и сборка

### 3.1 Сборка
- **Gradle** (multi-module):
  - `common/` — DTO и JSON-хелперы
  - `server/` — сервер
  - `client/` — JavaFX клиент

### 3.2 Клиент
- JavaFX 21 (`Canvas` для поля, таблица лидерборда, чат, профиль)
- UDP клиент на `DatagramSocket`
- Сетевое чтение в отдельном потоке + обновление UI через `Platform.runLater`

### 3.3 Сервер
- UDP сервер на `DatagramSocket`
- Игровой цикл: `ScheduledExecutorService`, шаг ~50мс (~20Hz)
- База данных: **PostgreSQL** (JDBC `org.postgresql:postgresql`)
- Пароли: PBKDF2 (salt + hash; реализация `PasswordUtil`)
- Таймаут неактивных UDP-сессий: ~90 секунд

### 3.4 База данных и запуск
Для локального запуска используется `docker compose` и `.env`.

---

## 4. Реализовано (фактическое состояние)

### 4.1 Сеть и протокол
- UDP протокол описан и реализован (см. `PROTOCOL.md`)
- `ping` для keepalive, `profile_get` для профиля/статистики

### 4.2 Авторизация
- `register` / `login`
- 1 активная сессия на username (повторный логин кикает старую сессию)
- безопасное хранение паролей (PBKDF2)

### 4.3 Игровой процесс
- движение по осям (без диагонали)
- след + захват территории (flood‑fill)
- «воровство» территории при захвате
- смерть игрока при пересечении его следа другим игроком, респавн
- score = размер текущей территории

### 4.4 Комнаты
- комнаты создаются лениво при `create_room/join_room`
- вместимость: до 4 игроков
- наблюдатель (`spectator=true`) получает `state`, но не управляет игроком
- при `login` сервер автоматически подбирает комнату (MAIN/любая неполная/AUTO<N>)

### 4.5 Чат
- чат внутри комнаты (`chat_send` → `chat_msg`)
- rate‑limit и ограничение длины сообщений
- системные сообщения (например, о достижениях) тоже идут через `chat_msg`

### 4.6 Статистика и достижения
- `user_stats`: kills/area и лучшие метрики
- `achievements`: разблокировки по порогам (сообщаются в чат системным сообщением)
- `profile_get` возвращает профиль и список достижений

### 4.7 Persistence
- PostgreSQL: `app_users`, `game_results`, `user_stats`, `achievements`
- запись результата при смерти/выходе игрока

---

## 5. Ограничения текущей версии
- Нет «лобби» со списком комнат и общим чатом лобби
- Нет матчей с таймером/победителем — игра идёт непрерывно
- Нет отдельного экрана Top Scores (есть best_score и история результатов в БД)
