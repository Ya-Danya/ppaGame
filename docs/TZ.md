# Техническое задание — PaperFX (актуально для MVP из архива)

Документ описывает **текущее состояние проекта** (MVP) и фиксирует, что уже реализовано, а что относится к будущей доработке до “полностью готового проекта”.

---

## 1. Цель проекта
Создать сетевую многопользовательскую игру, похожую на paper.io: **PaperFX** (клиент–сервер), где сервер авторитетно ведёт состояние игры в комнатах, а клиент визуализирует поле и отправляет ввод.

---

## 2. Ограничения и ключевые требования
- Язык: **Java 17**
- Сеть (строго):
  - TCP: `java.net.ServerSocket`, `java.net.Socket`
  - UDP (будущая доп. фича): `java.net.DatagramSocket`
- Формат сообщений: **TCP + JSON Lines** (см. `PROTOCOL.md`)
- Сервер — источник истины (anti‑cheat базово обеспечивается авторитетностью сервера)

---

## 3. Стек и сборка (как в текущем проекте)

### 3.1 Сборка
- **Gradle** (multi-module):
  - `common/` — DTO и JSON-хелперы
  - `server/` — сервер
  - `client/` — JavaFX клиент

### 3.2 Клиент
- JavaFX 21 (`Canvas` для поля, таблица лидерборда, чат)
- TCP клиент на `Socket`
- Сетевое чтение в отдельном потоке + обновление UI через `Platform.runLater`

### 3.3 Сервер
- TCP сервер на `ServerSocket/Socket`
- Игровой цикл: `ScheduledExecutorService`, шаг ~50мс
- База данных: **PostgreSQL** (JDBC `org.postgresql:postgresql`)
- Пароли: PBKDF2 (salt + hash; реализация `PasswordUtil`)

### 3.4 База данных и запуск
Для локального запуска используется `docker compose` и `.env`.

---

## 4. Архитектура (MVP)

### 4.1 Авторитетный сервер
Клиент отправляет только:
- `register/login`
- `input`
- `create_room/join_room`
- `chat_send`

Сервер:
- хранит комнаты и игроков
- обновляет позиции и территорию
- рассылает `state` всем подключенным в комнате

### 4.2 Комнаты
- Комнаты идентифицируются `roomId` (строка до 32 символов)
- Комната создаётся лениво при первом `create_room/join_room`
- Вместимость: до 4 игроков
- После `login` сервер автоматически присоединяет игрока в `MAIN`

### 4.3 Состояние игры
Состояние комнаты отправляется как `state` и содержит:
- геометрию сетки
- `owners[]` (владельцы клеток)
- список игроков с `x/y/score/color/trail`
- лидерборд по текущей территории

---

## 5. Реализовано в MVP (фактическое состояние)

### 5.1 Сеть и протокол
- TCP JSONL протокол описан и реализован (см. `PROTOCOL.md`)

### 5.2 Авторизация
- `register` / `login`
- 1 активная сессия на username (повторный логин кикает старое соединение)
- безопасное хранение паролей (PBKDF2)

### 5.3 Игровой процесс
- движение по осям (без диагонали)
- след + захват территории (flood‑fill)
- “воровство” территории при захвате
- смерть игрока при пересечении его следа другим игроком, респавн
- score = размер текущей территории

### 5.4 Чат
- чат внутри комнаты (`chat_send` → `chat_msg`)
- rate‑limit и ограничение длины сообщений

### 5.5 Persistence
- PostgreSQL таблицы: `app_users`, `game_results`, (заготовка) `achievements`
- запись результата при смерти/выходе игрока
- хранение `best_score` и `games_played` для пользователя

### 5.6 Клиентский UI
- экран Login/Register
- игровое окно: поле, лидерборд, чат
- быстрые сообщения (quick chat): клавиши **Q / E / R** отправляют заранее заданные фразы через `chat_send`

---

## 6. Не реализовано (и будет делаться дальше)

Это **не баги документации**, а реальный статус MVP:

1) Лобби как отдельное состояние:
   - список комнат (list rooms)
   - общий чат лобби
2) Управление стартом матча:
   - ready‑статусы
   - ручной старт / автостарт при заполнении
   - таймер матча и определение победителя
3) Top scores как отдельный экран и отдельные сообщения протокола (сейчас есть только best_score в БД, но нет RPC для выдачи топа)
4) Anti‑cheat расширенный:
   - лимит частоты `input`
   - валидация команд, защита от спама/флуда и т.п.
5) Достижения (таблица есть, логики нет)
6) Spectator Mode на клиенте (сервер уже поддерживает `spectator=true`, но UI отсутствует)
7) Второй сетевой протокол (UDP) — отдельная реализация клиента/сервера

---

## 7. Инструкция запуска (локально)

### 7.1 Поднять БД
В корне проекта:
```bash
docker compose up -d
```

Параметры БД задаются в `.env` (по умолчанию Postgres на `127.0.0.1:5433`, база `paperfx`, user/pass `paperfx`).

### 7.2 Запуск сервера
```bash
./gradlew :server:run
```

Gradle подхватывает `DB_URL/DB_USER/DB_PASS` из `.env` (или из переменных окружения).

Сервер слушает TCP `127.0.0.1:7777`.

### 7.3 Запуск клиента
```bash
./gradlew :client:run
```

---

## 8. Definition of Done для будущей “готовой версии”
Формальные критерии финальной готовности фиксируются в отдельном файле **HARD_REQUIREMENTS.md** (не изменяется при итерациях).
